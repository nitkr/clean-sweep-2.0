<?php
/**
 * Clean Sweep - Malware Display Functions
 *
 * Functions for displaying malware scan results and threat analysis
 */

/**
 * Display threats in timeline style organized by risk levels
 */
function clean_sweep_display_categorized_threats($scan_results) {
    $risk_threats = ['critical' => [], 'warning' => [], 'info' => []];

    // Group all threats by risk level first
    $all_threats = clean_sweep_extract_all_threats($scan_results);

    foreach ($all_threats as $threat) {
        $risk = clean_sweep_assign_risk_level($threat);

        // Also add category info to each threat
        $threat['_category'] = clean_sweep_categorize_threat($threat, $threat['_section'] ?? 'unknown');
        $risk_threats[$risk][] = $threat;
    }

    echo '<div class="threat-timeline" style="margin:20px 0;">';

    foreach (['critical' => 'üî¥ Critical Threats', 'warning' => 'üü° Warning Threats', 'info' => '‚ÑπÔ∏è Info Threats'] as $risk_level => $label) {
        if (!empty($risk_threats[$risk_level])) {
            $threat_count = count($risk_threats[$risk_level]);
            $is_critical = $risk_level === 'critical';
            $is_warning = $risk_level === 'warning';

            // For warning level, check if most threats are database-related
            $display_label = $label;
            if ($is_warning) {
                $db_threat_count = 0;
                foreach ($risk_threats[$risk_level] as $threat) {
                    if (($threat['_section'] ?? '') === 'database') {
                        $db_threat_count++;
                    }
                }

                // If 70%+ of warning threats are database-related, call it Database Threats
                if ($threat_count > 0 && ($db_threat_count / $threat_count) >= 0.7) {
                    $display_label = 'üóÑÔ∏è Database Threats';
                }
            }

            // Risk level header
            echo '<div class="timeline-section" style="margin-bottom:25px;">';
            echo '<h4 class="timeline-header" style="background:' . ($is_critical ? '#f8d7da' : ($is_warning ? '#fff3cd' : '#fff0f0')) . ';border-color:' . ($is_critical ? '#f5c6cb' : ($is_warning ? '#ffeaa7' : '#ffcccc')) . ';color:' . ($is_critical ? '#721c24' : ($is_warning ? '#856404' : '#cc0000')) . ';border:2px solid;padding:15px;border-radius:8px;margin:0;cursor:pointer;" onclick="toggleRiskLevel(\'' . $risk_level . '\')">';
            echo '<span style="float:right;font-size:18px;">‚ñº</span>';
            echo $display_label . ' <small>(' . $threat_count . ' total)</small>';
            echo '</h4>';

            // Collapsible content
            echo '<div class="timeline-content" id="timeline-' . $risk_level . '" style="display:' . ($is_critical ? 'block' : 'none') . ';">';

            // Group threats by category within this risk level
            $category_groups = [];
            foreach ($risk_threats[$risk_level] as $threat) {
                $category = $threat['_category'];
                if (!isset($category_groups[$category])) {
                    $category_groups[$category] = [];
                }
                $category_groups[$category][] = $threat;
            }

            // Sort categories (plugins/themes first)
            uksort($category_groups, function($a, $b) {
                $a_is_plugin = strpos($a, 'Plugin') !== false;
                $b_is_plugin = strpos($b, 'Plugin') !== false;
                $a_is_theme = strpos($a, 'Theme') !== false;
                $b_is_theme = strpos($b, 'Theme') !== false;

                if ($a_is_plugin && !$b_is_plugin) return -1;
                if ($b_is_plugin && !$a_is_plugin) return 1;
                if ($a_is_theme && !$b_is_theme) return -1;
                if ($b_is_theme && !$a_is_theme) return 1;

                return strcmp($a, $b);
            });

            foreach ($category_groups as $category_name => $threats_in_category) {
                $category_count = count($threats_in_category);

                echo '<div class="category-group" style="margin:15px 0;padding:15px;background:white;border:1px solid #dee2e6;border-radius:6px;">';

                // Category header
                echo '<h5 style="margin:0 0 10px 0;padding-bottom:8px;border-bottom:1px solid #e9ecef;">';

                // Category icon
                if (strpos($category_name, 'Plugin') !== false) {
                    echo 'üì¶';
                } elseif (strpos($category_name, 'Theme') !== false) {
                    echo 'üé®';
                } else {
                    echo 'üóÑÔ∏è';
                }

                echo ' <strong>' . htmlspecialchars($category_name) . '</strong>';
                echo '<span style="font-size:12px;color:#666;margin-left:10px;">(' . $category_count . ' threat' . ($category_count !== 1 ? 's' : '') . ')</span>';
                echo '</h5>';

                // Threat list
                echo '<div class="threat-list" style="margin-left:20px;">';
                foreach ($threats_in_category as $threat) {
                    clean_sweep_display_threat_timeline($threat, $threat['_section'] ?? 'unknown', $risk_level);
                }
                echo '</div>';

                echo '</div>';
            }

            echo '</div>'; // End timeline-content
            echo '</div>'; // End timeline-section
        }
    }

    echo '</div>'; // End threat-timeline

    // Add JavaScript for expand/collapse and copy functionality
    echo '<script>
        function toggleRiskLevel(riskLevel) {
            const content = document.getElementById("timeline-" + riskLevel);
            const header = content.previousElementSibling;
            const arrow = header.querySelector("span:first-child");

            if (content.style.display === "none") {
                content.style.display = "block";
                arrow.textContent = "‚ñ∂";
            } else {
                content.style.display = "none";
                arrow.textContent = "‚ñº";
            }
        }

        // Copy threat details to clipboard
        function copyThreatDetails(button) {
            const pattern = button.getAttribute("data-pattern") || "";
            const file = button.getAttribute("data-file") || "";
            const section = button.getAttribute("data-section") || "";

            // Get threat details from the parent threat item
            const threatItem = button.closest(".threat-item");
            let threatDetails = "";

            if (threatItem) {
                // Extract threat information
                const category = threatItem.querySelector(".threat-header strong")?.textContent?.trim() || "";
                const patternText = threatItem.querySelector(".threat-pattern")?.textContent?.trim() || "";
                const detailsText = threatItem.querySelector(".threat-details")?.textContent?.trim() || "";

                // Format the details
                threatDetails = `Clean Sweep - Malware Threat Details
=====================================

Category: ${category}
Section: ${section}
Pattern: ${patternText}
Details: ${detailsText}`;

                if (file) {
                    threatDetails += `\nFile: ${file}`;
                }
            } else {
                // Fallback format
                threatDetails = `Clean Sweep - Malware Threat Details
=====================================

Section: ${section}
Pattern: ${pattern}`;

                if (file) {
                    threatDetails += `\nFile: ${file}`;
                }
            }

            // Copy to clipboard using modern clipboard API with fallback
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(threatDetails).then(function() {
                    showCopyFeedback(button, "‚úÖ Copied!", "#28a745");
                }).catch(function(err) {
                    // Fall back to execCommand
                    fallbackCopy(button, threatDetails);
                });
            } else {
                // Use fallback method immediately
                fallbackCopy(button, threatDetails);
            }
        }

        // Fallback copy method for older browsers
        function fallbackCopy(button, text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.select();

            try {
                const successful = document.execCommand("copy");
                if (successful) {
                    showCopyFeedback(button, "‚úÖ Copied!", "#28a745");
                } else {
                    showCopyFeedback(button, "‚ùå Copy Failed", "#dc3545");
                }
            } catch (err) {
                showCopyFeedback(button, "‚ùå Copy Failed", "#dc3545");
            }

            document.body.removeChild(textArea);
        }

        // Show temporary visual feedback for copy action
        function showCopyFeedback(button, message, color) {
            const originalText = button.textContent;
            const originalBackground = button.style.backgroundColor || "#6c757d";

            button.textContent = message;
            button.style.backgroundColor = color;

            // Reset button after 2 seconds
            setTimeout(() => {
                button.textContent = originalText;
                button.style.backgroundColor = originalBackground;
            }, 2000);
        }
    </script>';

    // Add CSS for timeline layout
    echo '<style>
        .threat-timeline {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .timeline-section h4.timeline-header {
            transition: all 0.2s ease;
            position: relative;
        }

        .timeline-section h4.timeline-header:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .timeline-content {
            padding: 0;
            margin-top: 10px;
        }

        .category-group h5 {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .threat-list {
            border-left: 2px solid #dee2e6;
            padding-left: 15px;
            margin-left: 10px;
        }

        .threat-item {
            padding: 12px;
            margin: 8px 0;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .threat-item:hover {
            background: #ffffff;
            border-color: #b8daff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .threat-icon {
            font-size: 16px;
            margin-right: 8px;
        }

        .threat-pattern {
            font-family: "Courier New", monospace;
            font-weight: bold;
            color: #495057;
            background: #ffffff;
            padding: 4px 8px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
            margin: 6px 0;
            display: inline-block;
            font-size: 11px;
            word-break: break-word;
        }

        .threat-details {
            color: #6c757d;
            font-size: 13px;
            margin: 6px 0;
        }

        .threat-details strong {
            color: #495057;
        }

        .threat-actions {
            margin-top: 10px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .threat-actions button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .threat-actions button:hover {
            background: #5a6268;
        }
    </style>';
}

/**
 * Display individual threat in timeline format
 */
function clean_sweep_display_threat_timeline($threat, $section, $risk_level) {
    echo '<div class="threat-item">';

    // Header with icon and basic info
    $icon = $section === 'database' ? 'üóÑÔ∏è' : ($section === 'files' ? 'üìÅ' : '‚ö†Ô∏è');
    echo '<div class="threat-header">';
    echo '<span class="threat-icon">' . $icon . '</span>';
    echo '<strong>' . htmlspecialchars($threat['_category'] ?? 'Unknown') . '</strong>';
    echo '<small style="margin-left:8px;">' . ucfirst($section) . '</small>';
    echo '</div>';

    // Threat pattern
    echo '<div class="threat-pattern">';
    echo htmlspecialchars($threat['pattern'] ?? 'Unknown pattern');
    echo '</div>';

    // Threat details
    echo '<div class="threat-details">';
    if (isset($threat['match']) && !empty($threat['match'])) {
        $match = htmlspecialchars(substr($threat['match'], 0, 120));
        if (strlen($threat['match']) > 120) {
            $match .= '...';
        }
        echo '<strong>Match:</strong> ' . $match . '<br>';
    }

    // Context-specific details
    if ($section === 'database') {
        if (isset($threat['option_name'])) {
            echo '<strong>Option:</strong> ' . htmlspecialchars($threat['option_name']) . '<br>';
        }
        if (isset($threat['post_id'])) {
            echo '<strong>Post:</strong> <a href="post.php?post=' . $threat['post_id'] . '&action=edit" style="color:#007bff;" target="_blank">#' . $threat['post_id'] . '</a><br>';
        }
        if (isset($threat['user_id'])) {
            echo '<strong>User:</strong> ' . $threat['user_id'] . '<br>';
        }
        if (isset($threat['_table'])) {
            echo '<strong>Table:</strong> ' . htmlspecialchars($threat['_table']) . '<br>';
        }
    } elseif ($section === 'files' && isset($threat['file'])) {
        $file_info = basename($threat['file']);
        if (isset($threat['line_number'])) {
            $file_info .= ' (Line ' . $threat['line_number'] . ')';
        }
        echo '<strong>File:</strong> ' . htmlspecialchars($file_info) . '<br>';
        echo '<strong>Path:</strong> ' . htmlspecialchars($threat['file']) . '<br>';
    } elseif ($section === 'integrity' && isset($threat['file'])) {
        $file_info = basename($threat['file']);
        echo '<strong>Modified File:</strong> ' . htmlspecialchars($file_info) . '<br>';
        echo '<strong>Full Path:</strong> ' . htmlspecialchars($threat['file']) . '<br>';
        echo '<strong>Severity:</strong> <span style="color:#dc3545;font-weight:bold;">CRITICAL - Potential Reinfection</span><br>';
    }
    echo '</div>';

    // Actions - Only keep Copy Details button
    echo '<div class="threat-actions">';
    echo '<button onclick="copyThreatDetails(this)" data-pattern="' . htmlspecialchars($threat['pattern'] ?? '') . '" data-file="' . htmlspecialchars($threat['file'] ?? '') . '" data-section="' . htmlspecialchars($section) . '">üìã Copy Details</button>';
    echo '</div>';

    echo '</div>';
}

/**
 * Display individual threat as a card
 */
function clean_sweep_display_threat_card($threat, $section, $risk_level) {
    $risk_color = $risk_level === 'critical' ? '#dc3545' : ($risk_level === 'warning' ? '#ffc107' : '#17a2b8');
    $risk_icon = $risk_level === 'critical' ? 'üî¥' : ($risk_level === 'warning' ? 'üü°' : '‚ÑπÔ∏è');
    $risk_label = ucfirst($risk_level);

    echo '<div class="threat-card">';

    // Header with risk level
    echo '<div class="threat-header">';
    echo '<div>';
    echo '<h5 style="margin:0;color:' . $risk_color . ';font-size:14px;">' . $risk_icon . ' ' . $risk_label . ' Threat</h5>';
    if ($section === 'files' && isset($threat['file'])) {
        $file = basename($threat['file']);
        if (isset($threat['line_number'])) {
            $file .= ' (Line ' . $threat['line_number'] . ')';
        }
        echo '<div style="font-size:12px;color:#6c757d;margin-top:2px;">üìÅ ' . htmlspecialchars($file) . '</div>';
    } elseif ($section === 'database') {
        echo '<div style="font-size:12px;color:#6c757d;margin-top:2px;">üóÑÔ∏è ' . htmlspecialchars($threat['_table'] ?? 'Database') . '</div>';
    }
    echo '</div>';
    echo '</div>';

    // Threat pattern
    echo '<div class="threat-pattern">';
    echo htmlspecialchars($threat['pattern'] ?? 'Unknown pattern');
    echo '</div>';

    // Threat match/details
    echo '<div class="threat-details">';
    if (isset($threat['match']) && !empty($threat['match'])) {
        $match = htmlspecialchars(substr($threat['match'], 0, 150));
        if (strlen($threat['match']) > 150) {
            $match .= '...';
        }
        echo '<strong>Match:</strong> ' . $match . '<br>';
    }

    // Context-specific details
    if ($section === 'database') {
        if (isset($threat['option_name'])) {
            echo '<strong>Option:</strong> ' . htmlspecialchars($threat['option_name']) . '<br>';
        }
        if (isset($threat['post_id'])) {
            echo '<strong>Post ID:</strong> <a href="post.php?post=' . $threat['post_id'] . '&action=edit" style="color:#007bff;" target="_blank">' . $threat['post_id'] . '</a><br>';
        }
        if (isset($threat['user_id'])) {
            echo '<strong>User ID:</strong> ' . $threat['user_id'] . '<br>';
        }
    }
    echo '</div>';

    // Actions - Only keep Copy Details button
    echo '<div class="threat-actions">';
    echo '<button onclick="copyThreatDetails(this)" data-pattern="' . htmlspecialchars($threat['pattern'] ?? '') . '" data-file="' . htmlspecialchars($threat['file'] ?? '') . '" data-section="' . htmlspecialchars($section) . '">üìã Copy Details</button>';
    echo '</div>';

    echo '</div>';
}
